--3
CREATE OR REPLACE VIEW HIGHEST_BALANCE_RB AS
SELECT * FROM
(SELECT P.PATIENT_ID, P.NAME, P.ADDRESS, B.DATE_BILL, B.TOTAL, TOTAL_BY_COST_CENTER(100,B.BILL_ID) AS TOTAL_ROOM_BOARD
FROM PATIENTS P
JOIN BILLS B
ON B.PATIENT_ID = P.PATIENT_ID
ORDER BY TOTAL_ROOM_BOARD DESC) 
WHERE ROWNUM = 1;

SELECT * FROM HIGHEST_BALANCE_RB;


--4.a
CREATE OR REPLACE FUNCTION TOTAL_BY_COST_CENTER(cost_centerid number, billid number) RETURN DECIMAL IS
    rpta DECIMAL := 0;
BEGIN
    SELECT SUM (IT.PRICE) into rpta
    FROM BILLS B 
    JOIN BILL_DETAILS BD
    ON BD.BILL_ID = B.BILL_ID
    JOIN ITEMS IT
    ON IT.ITEM_ID = BD.ITEM_ID
    WHERE B.BILL_ID = billid AND IT.COST_CENTER_ID = cost_centerid;
    
    IF rpta is null THEN
        rpta := 0;
    END IF;
    
    RETURN rpta;
END;

SELECT TOTAL_BY_COST_CENTER(100,1) FROM DUAL;

--4.b
CREATE OR REPLACE FUNCTION QUANTITY_BY_COST_CENTER(cost_centerid number, billid number) RETURN NUMBER IS
    rpta NUMBER;
BEGIN
    SELECT COUNT(IT.PRICE) into rpta
    FROM BILLS B 
    JOIN BILL_DETAILS BD
    ON BD.BILL_ID = B.BILL_ID
    JOIN ITEMS IT
    ON IT.ITEM_ID = BD.ITEM_ID
    WHERE B.BILL_ID = billid AND IT.COST_CENTER_ID = cost_centerid;
    
    RETURN rpta;
END;

SELECT QUANTITY_BY_COST_CENTER(100,1) FROM DUAL;

--SE REALIZA PUNTO 5, CREACIÓN DE VISTA USANDO LAS FUNCIONES CREADAS ANTERIORMENTE

 --5   
CREATE OR REPLACE VIEW INFORMATION_OF_BILLS AS
SELECT P.PATIENT_ID, P.NAME, P.ADDRESS, B.DATE_BILL, B.DATE_ADMITED, B.DATE_DISCHARGE,
    QUANTITY_BY_COST_CENTER(100,B.BILL_ID) AS TOTAL_ITEMS_ROOM_BOARD, TOTAL_BY_COST_CENTER(100,B.BILL_ID) AS BALANCE_ROOM_AND_BOARD,
    QUANTITY_BY_COST_CENTER(110,B.BILL_ID) AS TOTAL_ITEMS_LABORATORY, TOTAL_BY_COST_CENTER(110,B.BILL_ID) AS BALANCE_LABORATORY, 
    QUANTITY_BY_COST_CENTER(125,B.BILL_ID) AS TOTAL_ITEMS_RADIOLOGY, TOTAL_BY_COST_CENTER(125,B.BILL_ID) AS BALANCE_RADIOLOGY
FROM PATIENTS P
JOIN BILLS B
ON B.PATIENT_ID = P.PATIENT_ID;

SELECT * FROM INFORMATION_OF_BILLS;